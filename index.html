<!--<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PWA ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼ â€” è»½é‡ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ©ãƒ¼ä½é…å»¶ç‰ˆ</title>
<meta name="theme-color" content="#1e293b">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo;background:#071021;color:#e6eef6;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{width:980px;max-width:95%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));padding:18px;border-radius:12px}
  h1{margin:0 0 8px;font-size:18px}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  label{font-size:13px;color:#cfe6ff}
  input[type=range]{width:220px}
  button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a4;color:white;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .status{font-size:13px;color:#9fb7cf}
</style>
</head>
<body>
  <div class="card">
    <h1>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼ï¼ˆè»½é‡ã‚°ãƒ©ãƒ‹ãƒ¥ãƒ©ãƒ¼ä½é…å»¶ç‰ˆï¼‰</h1>
    <p class="status">AudioWorklet ãŒä½¿ãˆãªã„å ´åˆã¯ ScriptProcessor ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚Safari / iOS ã«ã‚‚å¯¾å¿œã€‚è»½é‡åŒ–ã—ã¦é…å»¶ã‚’ç´„0.2ç§’ä»¥ä¸‹ã«æŠ‘ãˆã¦ã„ã¾ã™ã€‚</p>

    <div class="row">
      <button id="btnStart">Start</button>
      <button id="btnStop" class="ghost" disabled>Stop</button>
      <div style="margin-left:auto;">çŠ¶æ…‹: <span id="state">åœæ­¢ä¸­</span></div>
    </div>

    <div class="row">
      <label>ãƒ”ãƒƒãƒï¼ˆåŠéŸ³ï¼‰ <span id="pval">0</span></label>
      <input type="range" id="pitch" min="-12" max="12" value="0">
      <label style="margin-left:18px">éŸ³é‡ <span id="vval">0.50</span></label>
      <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
    </div>

    <div style="margin-top:12px;font-size:12px;color:#9fb7cf">
      é…å»¶ã‚’æœ€å°åŒ–ã™ã‚‹ãŸã‚ã€çŸ­ã„ãƒãƒƒãƒ•ã‚¡ï¼ˆ256ã€œ512ï¼‰ã¨è»½é‡ãƒ”ãƒƒãƒè£œé–“ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
    </div>
  </div>

<script>
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const stateEl = document.getElementById('state');
const pitchEl = document.getElementById('pitch');
const pval = document.getElementById('pval');
const volumeEl = document.getElementById('volume');
const vval = document.getElementById('vval');

pval.textContent = pitchEl.value;
vval.textContent = volumeEl.value;

pitchEl.addEventListener('input', ()=> pval.textContent = pitchEl.value);
volumeEl.addEventListener('input', ()=> vval.textContent = volumeEl.value);

let audioContext = null;
let micStream = null;
let sourceNode = null;
let gainOut = null;
let workletNode = null;
let scriptNode = null;

async function startAudio() {
  if (audioContext) return;
  audioContext = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: "interactive" });
  await audioContext.resume();

  gainOut = audioContext.createGain();
  gainOut.gain.value = Number(volumeEl.value);
  gainOut.connect(audioContext.destination);

  try {
    // AudioWorkletè»½é‡ç‰ˆ
    const processorCode = `
    class LightPitchShift extends AudioWorkletProcessor {
      static get parameterDescriptors(){return[{name:'rate',defaultValue:1}]}
      constructor(){super();this.buf=new Float32Array(8192);this.wp=0;this.rp=0;}
      interp(idx){const i0=Math.floor(idx)&8191;const i1=(i0+1)&8191;const f=idx-Math.floor(idx);return this.buf[i0]*(1-f)+this.buf[i1]*f;}
      process(inputs,outputs,params){const i=inputs[0][0];const o=outputs[0][0];if(!i)return true;const rate=params.rate;const r=rate.length>1?rate[0]:rate[0];for(let n=0;n<i.length;n++){this.buf[this.wp]=i[n];this.wp=(this.wp+1)&8191;o[n]=this.interp(this.rp);this.rp+=r;if(this.rp>=8192)this.rp-=8192;}return true;}}
    registerProcessor('light-pitch',LightPitchShift);
    `;
    const blob=new Blob([processorCode],{type:'application/javascript'});
    const url=URL.createObjectURL(blob);
    await audioContext.audioWorklet.addModule(url);

    micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    sourceNode = audioContext.createMediaStreamSource(micStream);
    workletNode = new AudioWorkletNode(audioContext,'light-pitch',{parameterData:{rate:1}});
    sourceNode.connect(workletNode).connect(gainOut);

    const updateRate=()=>{
      const semis=Number(pitchEl.value);
      const rate=Math.pow(2,semis/12);
      workletNode.parameters.get('rate').setValueAtTime(rate,audioContext.currentTime);
    };
    pitchEl.addEventListener('input',updateRate);
    volumeEl.addEventListener('input',()=>{gainOut.gain.value=Number(volumeEl.value);});
    updateRate();

    stateEl.textContent='å†ç”Ÿä¸­ (AudioWorklet)';
    btnStart.disabled=true;btnStop.disabled=false;
  } catch(err){
    console.warn('AudioWorklet unavailable, fallback',err);
    micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    sourceNode = audioContext.createMediaStreamSource(micStream);
    const bufferSize=512; // ä½é…å»¶
    scriptNode = audioContext.createScriptProcessor(bufferSize,1,1);
    const buf=new Float32Array(8192);let wp=0;let rp=0;
    scriptNode.onaudioprocess=e=>{
      const i=e.inputBuffer.getChannelData(0);
      const o=e.outputBuffer.getChannelData(0);
      const semis=Number(pitchEl.value);
      const rate=Math.pow(2,semis/12);
      for(let n=0;n<i.length;n++){buf[wp]=i[n];wp=(wp+1)&8191;o[n]=buf[Math.floor(rp)&8191];rp+=rate;if(rp>=8192)rp-=8192;}
    };
    sourceNode.connect(scriptNode).connect(gainOut);
    pitchEl.addEventListener('input',()=>{});
    volumeEl.addEventListener('input',()=>{gainOut.gain.value=Number(volumeEl.value);});
    stateEl.textContent='å†ç”Ÿä¸­ (ScriptProcessor)';
    btnStart.disabled=true;btnStop.disabled=false;
  }
}

function stopAudio(){
  if(!audioContext)return;
  if(workletNode){workletNode.disconnect();workletNode=null;}
  if(scriptNode){scriptNode.disconnect();scriptNode=null;}
  if(sourceNode){sourceNode.disconnect();sourceNode=null;}
  if(micStream){micStream.getTracks().forEach(t=>t.stop());micStream=null;}
  audioContext.close();audioContext=null;
  stateEl.textContent='åœæ­¢ä¸­';
  btnStart.disabled=false;btnStop.disabled=true;
}

btnStart.addEventListener('click',async()=>{
  try{await startAudio();}catch(e){alert('ãƒã‚¤ã‚¯ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: '+e.message);}
});
btnStop.addEventListener('click',()=>stopAudio());
</script>
</body>
</html>-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4A90E2">
<style>
body {
  font-family: system-ui, sans-serif;
  text-align: center;
  padding: 2em;
  background: linear-gradient(180deg, #e0f2ff, #ffffff);
}
button, select, input {
  margin: 0.5em;
  padding: 0.7em 1.2em;
  border-radius: 10px;
  border: none;
  font-size: 1em;
  background: #4A90E2;
  color: white;
  cursor: pointer;
}
button:hover { background: #357ABD; }
label { display: block; margin-top: 1em; font-weight: bold; }
</style>
</head>
<body>
<h2>ğŸ™ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼</h2>

<button id="start">Start</button>
<select id="voiceType">
  <option value="neutral">Normal</option>
  <option value="male">Male</option>
  <option value="female">Female</option>
  <option value="robot">Robot</option>
</select>
<br>
<label>Volume:
  <input id="volume" type="range" min="0" max="1" step="0.01" value="0.5">
</label>

<script>
let context, source, pitchNode, gainNode, filterNode, formantFilter, compressor;

document.getElementById("start").onclick = async () => {
  context = new AudioContext({ latencyHint: "interactive" });
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  source = context.createMediaStreamSource(stream);

  // å„ãƒãƒ¼ãƒ‰ä½œæˆ
  pitchNode = context.createDelay(0.05);
  filterNode = context.createBiquadFilter();
  formantFilter = context.createBiquadFilter();
  gainNode = context.createGain();
  compressor = context.createDynamicsCompressor();

  gainNode.gain.value = document.getElementById("volume").value;
  document.getElementById("volume").oninput = e => gainNode.gain.value = e.target.value;

  // ãƒãƒ¼ãƒ‰æ¥ç¶š
  source.connect(pitchNode);
  pitchNode.connect(filterNode);
  filterNode.connect(formantFilter);
  formantFilter.connect(compressor);
  compressor.connect(gainNode);
  gainNode.connect(context.destination);

  // åˆæœŸè¨­å®š
  filterNode.type = "highpass";
  filterNode.frequency.value = 120;
  formantFilter.type = "peaking";
  formantFilter.frequency.value = 1000;

  // éŸ³å£°ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚
  document.getElementById("voiceType").onchange = e => {
    const type = e.target.value;
    switch (type) {
      case "male":
        pitchNode.delayTime.value = 0.002;
        formantFilter.frequency.value = 800;
        formantFilter.Q.value = 1;
        break;
      case "female":
        pitchNode.delayTime.value = -0.002;
        formantFilter.frequency.value = 1800;
        formantFilter.Q.value = 1.2;
        break;
      case "robot":
        pitchNode.delayTime.value = 0.004;
        formantFilter.frequency.value = 400;
        formantFilter.Q.value = 0.7;
        break;
      default:
        pitchNode.delayTime.value = 0;
        formantFilter.frequency.value = 1000;
        formantFilter.Q.value = 1;
    }
  };
};

// PWAã®ServiceWorkerç™»éŒ²
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>
</body>
</html>
